SELECT
    m.íšŒì›ID,
    m.íšŒì›ëª…,
    m.íšŒì›ë“±ê¸‰,

    /* ì›”ë³„ ì£¼ë¬¸ í†µê³„ */
    TO_CHAR(o.ì£¼ë¬¸ë‚ ì§œ, 'YYYY-MM')                AS ì£¼ë¬¸ì›”,

    COUNT(DISTINCT o.ì£¼ë¬¸ID)                      AS ì›”ì£¼ë¬¸ìˆ˜,

    /* ì›” ê²°ì œ ê¸ˆì•¡ */
    SUM(p.ì´ìƒí’ˆê¸ˆì•¡)                             AS ì›”ê²°ì œê¸ˆì•¡,

    /* í‰ê·  ì£¼ë¬¸ ê¸ˆì•¡ (AOV) */
    ROUND(
        SUM(p.ì´ìƒí’ˆê¸ˆì•¡)
        / NULLIF(COUNT(DISTINCT o.ì£¼ë¬¸ID), 0),
        0
    )                                              AS í‰ê· ì£¼ë¬¸ê¸ˆì•¡,

    /* ìƒí’ˆêµ°ë³„ ë§¤ì¶œ */
    SUM(
        CASE
            WHEN pr.ìƒí’ˆë¶„ë¥˜ = 'ì»¤í”¼'
            THEN od.ì£¼ë¬¸ìˆ˜ëŸ‰ * pr.ì›ê°€ * (1 - pr.í• ì¸ìœ¨ / 100)
            ELSE 0
        END
    )                                              AS ì»¤í”¼ë§¤ì¶œ,

    SUM(
        CASE
            WHEN pr.ìƒí’ˆë¶„ë¥˜ = 'ì•…ì„¸ì„œë¦¬'
            THEN od.ì£¼ë¬¸ìˆ˜ëŸ‰ * pr.ì›ê°€ * (1 - pr.í• ì¸ìœ¨ / 100)
            ELSE 0
        END
    )                                              AS ì•…ì„¸ì„œë¦¬ë§¤ì¶œ,

    /* ì»¤í”¼ ë§¤ì¶œ ë¹„ì¤‘ */
    ROUND(
        SUM(
            CASE
                WHEN pr.ìƒí’ˆë¶„ë¥˜ = 'ì»¤í”¼'
                THEN od.ì£¼ë¬¸ìˆ˜ëŸ‰ * pr.ì›ê°€ * (1 - pr.í• ì¸ìœ¨ / 100)
                ELSE 0
            END
        )
        / NULLIF(SUM(p.ì´ìƒí’ˆê¸ˆì•¡), 0),
        3
    )                                              AS ì»¤í”¼ë§¤ì¶œë¹„ì¤‘,

    /* ìµœê·¼ ì£¼ë¬¸ì¼ */
    lo.ìµœê·¼ì£¼ë¬¸ì¼,

    /* ìµœê·¼ ì£¼ë¬¸ ì´í›„ ê²½ê³¼ì¼ */
    TRUNC(SYSDATE - lo.ìµœê·¼ì£¼ë¬¸ì¼)                AS ìµœê·¼ì£¼ë¬¸ê²½ê³¼ì¼

FROM íšŒì› m

JOIN ì£¼ë¬¸ o
    ON m.íšŒì›ID = o.íšŒì›ID

JOIN ê²°ì œ p
    ON o.ì£¼ë¬¸ID = p.ì£¼ë¬¸ID

JOIN ì£¼ë¬¸ìƒì„¸ od
    ON o.ì£¼ë¬¸ID = od.ì£¼ë¬¸ID

JOIN ìƒí’ˆ pr
    ON od.ìƒí’ˆID = pr.ìƒí’ˆID

/* ðŸ”¥ íšŒì›ë³„ ìµœê·¼ ì£¼ë¬¸ (ìœˆë„ìš° í•¨ìˆ˜) */
LEFT JOIN (
    SELECT
        íšŒì›ID,
        ì£¼ë¬¸ë‚ ì§œ AS ìµœê·¼ì£¼ë¬¸ì¼
    FROM (
        SELECT
            o2.íšŒì›ID,
            o2.ì£¼ë¬¸ë‚ ì§œ,
            ROW_NUMBER() OVER (
                PARTITION BY o2.íšŒì›ID
                ORDER BY o2.ì£¼ë¬¸ë‚ ì§œ DESC, o2.ì£¼ë¬¸ID DESC
            ) rn
        FROM ì£¼ë¬¸ o2
    )
    WHERE rn = 1
) lo
    ON lo.íšŒì›ID = m.íšŒì›ID

WHERE 1 = 1

  /* íƒˆí‡´ ì•ˆ í•œ íšŒì› (ì„ íƒë„ ê±°ì˜ ì—†ìŒ) */
  AND NVL(m.íƒˆí‡´ì—¬ë¶€, 'N') = 'N'

  /* 2026ë…„ ì „ì²´ + ë‚ ì§œ í•¨ìˆ˜ë¡œ ì¸ë±ìŠ¤ ë¬´íš¨ */
  AND TO_CHAR(o.ì£¼ë¬¸ë‚ ì§œ, 'YYYY-MM-DD')
      BETWEEN '2026-01-01' AND '2026-12-31'

  /* ê²°ì œ ì™„ë£Œ (ëŒ€ë¶€ë¶„ TRUE) */
  AND p.ê²°ì œìƒíƒœ = 'ê²°ì œì™„ë£Œ'

  /* ì¿ í° ë¯¸ì‚¬ìš© ìœ ì €ê°€ ëŒ€ë¶€ë¶„ â†’ ë§¤ rowë§ˆë‹¤ ê²€ì‚¬ */
  AND NOT EXISTS (
        SELECT 1
        FROM ê²°ì œ px
        WHERE px.ì£¼ë¬¸ID = o.ì£¼ë¬¸ID
          AND NVL(px.ì ìš©ì¿ í°í• ì¸ê¸ˆì•¡, 0) > 0
  )

GROUP BY
    m.íšŒì›ID,
    m.íšŒì›ëª…,
    m.íšŒì›ë“±ê¸‰,
    TO_CHAR(o.ì£¼ë¬¸ë‚ ì§œ, 'YYYY-MM'),
    lo.ìµœê·¼ì£¼ë¬¸ì¼

HAVING
    /* ì§‘ê³„ í›„ í•„í„° */
    SUM(p.ì´ìƒí’ˆê¸ˆì•¡) >= 300000
    AND COUNT(DISTINCT o.ì£¼ë¬¸ID) >= 2

ORDER BY
    ì£¼ë¬¸ì›”,
    ì›”ê²°ì œê¸ˆì•¡ DESC;